name: Check Reproduction
on:
  issues:
    types: [opened]
  workflow_dispatch:

jobs:
  triage-issue:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0

      - name: Check Reproduction
        uses: anthropics/claude-code-action@c05ccc5ce416f3129e97c8d17188813fef66f002
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: |
            --allowedTools "Bash(gh label list),mcp__github__get_issue,mcp__github__get_issue_comments,mcp__github__add_issue_comment,mcp__github__update_issue,mcp__github__create_issue_comment,mcp__github__search_issues,mcp__github__list_issues"
          prompt: |-
            You're an issue assistant for GitHub issues. Your task is to analyze the issue and determine whether it includes a minimal reproduction. If not, you should apply the `needs reproduction` label and post a helpful comment explaining why.

            Issue Information:
            - REPO: ${{ github.repository }}
            - ISSUE_NUMBER: ${{ github.event.issue.number }}

            TASK OVERVIEW:

            1. Analyze for Minimal Reproduction
                Look for evidence that the reporter has provided a minimal reproduction. This may appear as:

                (a) Failing Test Case PR
                - Reference to a pull request that introduces a failing test
                - Mentions of CI verifying a failing test
                - Phrases like “added failing test”, “test case shows bug”, or similar

                (b) Reproducible Project or Playground
                - A link to a standalone repository, REPL, Stackblitz, or similar that demonstrates the bug
                - Instructions that allow maintainers to run the reproduction (e.g., `npm install && npm run build`)
                - A README or clear description explaining expected vs actual behavior
                - Evidence that the code is minimal (i.e., unnecessary dependencies are stripped out)

                (c) Clear Procedure to Reproduce
                 - The issue must describe a step-by-step procedure that maintainers can follow
                 - The steps should require minimal effort and no extra setup beyond the provided instructions
                 - The expected outcome and the actual observed outcome should both be stated clearly

            2. Apply Labels and Comment
                - If the issue does not include a minimal reproduction:
                  a) Apply the label: `needs reproduction`
                  b) Post a minimal helpful comment explaining why the issue needs a reproduction
                    - You MUST only explain why, DO NOT explain how to create a minimal reproduction
                    - Explain specifically what was missing (e.g., "no runnable code example provided" or "no reproduction link found")

            IMPORTANT GUIDELINES:
            - Be thorough when checking for reproductions
            - Only apply labels from the repository's existing label list
            - ONLY post a comment if you apply the `needs reproduction` label
            - DO NOT comment if the issue already has a minimal reproduction