# Circle Smart Account

## Install

:::info
This package & guide is maintained by [Circle](https://www.circle.com).
:::

Make sure to add [Circle's Modular Wallets](https://developers.circle.com/w3s/modular-wallets) SDK to your project:

```shell
npm install @circle-fin/modular-wallets-core
```

This package provides utilities for passkey authentication and smart account creation.

## Prerequisites

Before you start, make sure you've:

* Setup and retrieve your `CLIENT_KEY` and `CLIENT_URL` [by following this step](https://developers.circle.com/w3s/modular-wallets-setup).  
* Configured a domain for WebAuthn passkey registration.  
* Familiarize yourself with [Circle's API Key and Client Key authentication](https://developers.circle.com/w3s/web3-services-api-client-keys-auth).


## Create a Passkey Credential

First, register a new **passkey** (WebAuthn credential) or use an existing one for your user. The Circle SDK uses a **Passkey server** to handle WebAuthn registration and login. We need to initialize a Passkey transport with the Circle **Client Key** and **Client URL** (obtained from the Circle Modular Wallets console setup), then create a credential:

```ts
import { toPasskeyTransport, toWebAuthnCredential, WebAuthnMode } from '@circle-fin/modular-wallets-core'

// 1. Retrieve your Circle Client Key and Client URL from environment (set in .env)
const clientKey = '...'
const clientUrl = 'https://...'

// 2. Initialize a Passkey transport for Circle's Passkey service
const passkeyTransport = toPasskeyTransport(clientUrl, clientKey)

// 3. Register a new passkey (WebAuthn) credential for the user
const credential = await toWebAuthnCredential({
  transport: passkeyTransport,
  mode: WebAuthnMode.Register,          // or WebAuthnMode.Login to use an existing credential
  username: 'user-example',         // a unique username for the credential
})
```

This will trigger the WebAuthn flow in the browser (e.g. biometric prompt) and yield a `credential` object for the passkey.

## Connect the Client

Next, create a Viem **public client** configured to use Circle's infrastructure. Circle provides custom RPC endpoints (via the Client URL) for each supported network. Use `toModularTransport` to get a Viem transport for your target chain, and then initialize the client. For example, to connect to the Polygon Amoy testnet (a Circle test network):

```ts
import { toModularTransport } from '@circle-fin/modular-wallets-core'
import { createPublicClient } from 'viem'
import { polygonAmoy } from 'viem/chains'

// 4. Create a Circle Modular transport for the chosen chain (Polygon Amoy testnet in this example)
const modularTransport = toModularTransport(
  `${clientUrl}/polygonAmoy`, // append the chain route to the Client URL
  clientKey,
)

// 5. Initialize a Viem public client with the Circle transport
const publicClient = createPublicClient({
  chain: polygonAmoy,
  transport: modularTransport,
})
```

**Note:** When calling `toModularTransport`, specify a supported network path. Circle's Modular Wallet service supports major EVM chains (Ethereum, Polygon, Base, Optimism, Arbitrum, etc., including their testnets). For example, use `"${clientUrl}/baseSepolia"` for Base Sepolia, `".../optimism"` for Optimism, and so on.

## Create a Circle Smart Account

With the client ready and a passkey credential available, you can create the **Circle Smart Account**. This smart account is a contract wallet (an ERC-4337 & ERC-6900 compatible smart contract) controlled by the passkey. We'll transform the WebAuthn credential into a Viem account object and then generate the smart account:

```ts
import { toCircleSmartAccount } from '@circle-fin/modular-wallets-core'
import { toWebAuthnAccount } from 'viem/account-abstraction'

// 6. Convert the WebAuthn credential into a Viem Account for signing
const ownerAccount = toWebAuthnAccount({
  credential,  // use the credential obtained from the passkey registration
})

// 7. Create a Circle Smart Account using the public client and the passkey-based owner
const smartAccount = await toCircleSmartAccount({
  client: publicClient,
  owner: ownerAccount,
})
```

## Set up a Bundler Client

To send transactions from a smart account, we use an ERC-4337 **Bundler**. Viem provides a Bundler client that interfaces with bundler RPC endpoints. Using Circle's Modular transport, we can create a Bundler client that will forward User Operations to Circle's bundler.

```ts
import { createBundlerClient } from 'viem/account-abstraction'

// 8. Initialize a Bundler client for sending User Operations via Circle's bundler
const bundlerClient = createBundlerClient({
  account: smartAccount,      // the Smart Account we just created
  chain: polygonAmoy,         // the chain the bundler should target (must match the smartAccount's chain)
  transport: modularTransport,
})
```

## Send a Gasless USDC Transaction

Finally, let's send a token transfer from the smart account **without requiring the user to pay gas**. In this example, we'll transfer **1 USDC** on the test network to an arbitrary address. Circle's bundler and paymaster will sponsor the gas fees as long as a Gas Station policy is in place (on testnet, a default policy is usually already configured).

We will use the Circle SDK's helper to encode an ERC-20 transfer call and then send a User Operation via the bundler client:

```ts
import { encodeTransfer } from '@circle-fin/modular-wallets-core'
import { parseUnits } from 'viem'

// 9. Prepare an ERC-20 token transfer call (e.g., send 1.0 USDC to a recipient)
const USDC_ADDRESS = '0x41e94eb019c0762f9bfcf9fb1e58725bfb0e7582'  // USDC contract on Polygon Amoy testnet
const USDC_DECIMALS = 6

const recipient = '0x...recipient_address...'
const amount = parseUnits('1', USDC_DECIMALS)  // 1 USDC in base units (10^6)

const callData = encodeTransfer(recipient, USDC_ADDRESS, amount)

// 10. Send the user operation through the bundler (gas fees sponsored via paymaster)
const userOpHash = await bundlerClient.sendUserOperation({
  calls: [callData],
  paymaster: true,
})
```

The bundler returns a `userOpHash` for the submitted operation. You can then wait for the transaction to be mined:

```ts
const { receipt } = await bundlerClient.waitForUserOperationReceipt({ hash: userOpHash })
console.log('Transaction hash:', receipt.transactionHash)
```

That's it!

You have created a Circle Smart Account with a passkey and sent a gasless USDC transfer using Viem.

The Circle Modular Wallets SDK seamlessly handles the account abstraction flow – from passkey-based signing to sponsored gas payments – allowing you to build a user-friendly dApp without exposing the complexity of gas fees to your users.


## Example Apps

The Circle team has prepared working demos to help you get started quickly with Modular Wallets:

* [Modular Wallet + Passkey (Replit)](https://replit.com/@buildoncircle/modular-wallet-passkey) – A simple web demo showcasing passkey login and gasless USDC transfer.  
* [Modular Wallets Web SDK Example (GitHub)](https://github.com/circlefin/modularwallets-web-sdk/tree/master/examples/circle-smart-account) – A full React implementation using Circle Smart Accounts, bundler, and paymaster.

Use these as references when building or testing your own integration. 